trigger:
  branches:
    include:
      - main
      - master

pool:
  vmImage: 'ubuntu-latest'

variables:
  buildConfiguration: 'Release'

stages:
  # CI - Build + Test + Artifact
  - stage: CI
    displayName: "Integração Contínua (Build + Testes)"
    jobs:
      - job: BuildAndTest
        displayName: "Build e Testes Automáticos"
        steps:
          - checkout: self

          # 1. Instala o SDK do .NET
          - task: UseDotNet@2
            inputs:
              packageType: 'sdk'
              version: '9.0.x'
              

          # 2. Restaura dependências
          - script: dotnet restore
            displayName: 'Restaurar dependências'

          # 3. Build da aplicação
          - script: dotnet build --configuration $(buildConfiguration)
            displayName: 'Compilar aplicação'

          # 4. Executa testes unitários e de integração
          - script: dotnet test --configuration $(buildConfiguration) --no-build --logger trx --results-directory $(Build.ArtifactStagingDirectory)/TestResults
            displayName: 'Executar testes automatizados'

          # 5. Publica artefatos (para o CD)
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: '$(Build.ArtifactStagingDirectory)'
              ArtifactName: 'drop'
              publishLocation: 'Container'

  # CD - Deploy automático
  - stage: CD
    displayName: "Entrega Contínua (Deploy no Azure)"
    dependsOn: CI
    condition: succeeded()
    jobs:
      - job: Deploy
        displayName: "Executar Deploy"
        steps:
          - checkout: self

          # 1. Conecta ao Azure e executa script de deploy (como você já faz)
          - task: AzureCLI@2
            inputs:
              azureSubscription: 'qmove-azure-connection'
              scriptType: 'bash'
              scriptLocation: 'inlineScript'
              inlineScript: |
                chmod +x ./deploy.sh
                ./deploy.sh
            displayName: 'Deploy via Azure CLI'
