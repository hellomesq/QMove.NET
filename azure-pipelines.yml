# ============================================
# ğŸš€ PIPELINE DE CI/CD - PROJETO MOTO MONITORAMENTO
# ============================================

trigger:
  branches:
    include:
      - main   # executa automaticamente quando hÃ¡ push na main

pool:
  vmImage: 'windows-latest'  # usa agente Windows com .NET instalado

variables:
  buildConfiguration: 'Release'

# =============================
# ğŸ§± ETAPA 1: RESTAURAR E COMPILAR
# =============================
steps:
- task: UseDotNet@2
  displayName: 'ğŸ”§ Configurar versÃ£o do .NET SDK'
  inputs:
    packageType: 'sdk'
    version: '9.0.x'   

- script: |
    echo "ğŸ” Restaurando dependÃªncias..."
    dotnet restore
  displayName: 'ğŸ“¦ Restaurar pacotes NuGet'

- script: |
    echo "ğŸ—ï¸ Compilando soluÃ§Ã£o..."
    dotnet build --configuration $(buildConfiguration) --no-restore
  displayName: 'âš™ï¸ Compilar projeto'

# =============================
# ğŸ§ª ETAPA 2: EXECUTAR TESTES AUTOMATIZADOS
# =============================
- script: |
    echo "ğŸš€ Executando testes UnitÃ¡rios..."
    dotnet test MotoMonitoramento.Tests.Unit/MotoMonitoramento.Tests.Unit.csproj --configuration $(buildConfiguration) --no-build --verbosity normal --logger "trx;LogFileName=unit-tests.trx"

    echo "ğŸš€ Executando testes de IntegraÃ§Ã£o..."
    dotnet test MotoMonitoramento.Tests.Integration/MotoMonitoramento.Tests.Integration.csproj --configuration $(buildConfiguration) --no-build --verbosity normal --logger "trx;LogFileName=integration-tests.trx"
  displayName: 'ğŸ§ª Executar testes automatizados'

# =============================
# ğŸ“Š ETAPA 3: PUBLICAR RESULTADOS DOS TESTES
# =============================
- task: PublishTestResults@2
  inputs:
    testResultsFormat: 'VSTest'
    testResultsFiles: '**/*.trx'  # procura os resultados gerados pelos testes
    failTaskOnFailedTests: true
  displayName: 'ğŸ“Š Publicar resultados dos testes'

# =============================
# ğŸ“¦ ETAPA 4: PUBLICAR ARTEFATOS (opcional)
# =============================
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: '$(Build.ArtifactStagingDirectory)'
    ArtifactName: 'drop'
    publishLocation: 'Container'
  displayName: 'ğŸ“¦ Publicar artefatos de build (opcional)'
